# 11.1什么是线程

[toc]

我们今天的课程会讨论线程以及XV6如何实现线程切换。今天这节课与之前介绍的系统调用，Interrupt，page table和锁的课程一样，都是有关XV6底层实现的课程。今天我们将讨论XV6如何在多个线程之间完成切换。

为什么人们需要多线程，原因如下：

* 人们希望他们的计算机能够同时执行多个任务，有可能计算机需要执行分时复用的任务，例如MIT的公共计算机系统Athena就允许多个用户同时登录一台计算机，并运行各自的进程。甚至在一个单用户的计算机或者在你的iphone上，你会运行多个进程，并期望计算机完成所有的任务而不仅仅只是一个任务。
* 多线程可以让程序的结构变得简单。线程可以在某些场合一更加简单，优雅的方式减少代码的复杂度。在第一个实验的质数筛中已经得到体现。尽管没有使用多线程，但是使用了多进程来帮助我们构建质数筛代码。
* 最后，多线程可以通过并行运算，在多核计算机上获得更快的处理速度。常见的方式是对程序进行拆分，并通过线程在不同的CPU核心上运行程序的不同部分，如果你足够幸运的话，你可以将你的程序拆分并在4个CPU核上通过4个线程运行你的程序，已获得4倍的程序运行速度。xv6就是一个多核并行运算的程序。

线程可以看作是一种多任务时简化代码的抽象，线程可以看作是一个串行执行的代码单元。如果你写了个顺序执行的程序，那么这个程序可以被看作是单线程程序。这是对于线程的一种宽松的定义。虽然人们对于线程有很多不同的定义，在这里，我们认为线程就是一个串行执行的代码的单元，它运行时候只占用一个CPU并且以普通的方式一个接一个的执行指令。

![img](.assets/image%20(444).png)

我们经常讨论线程的状态，因为，我们可以随时保存线程的状态并暂停线程的运行，并在之后通过恢复线程的状态来让其继续运行。线程的状态包括3个最重要的部分：

- 程序计数器（Program Counter），它表示当前线程执行指令的位置。
- 保存变量的寄存器。
- 程序的栈，通常来说每个线程都有自己的栈，stack记录了函数的调用记录，并反映了当前线程的执行状况。

![img](.assets/image%20(571).png)

xv6里面包含了一个线程系统，这个线程系统是干啥的？是管理多个线程交错运行的。我们有时会启动上千个thread，而操作系统中的thread System就是管理这些线程并让其正常工作的。

让多线程并行，这里主要有两个策略：

* 第一个策略是在多核处理器上使用多个CPU，每个CPU上可以运行一个线程，如果你有4个CPU，那么每个CPU可以运行一个线程。每个线程自动根据所在的CPU就有相应的程序计数器PC，与相应的寄存器REGS。但是如果你只有4个CPU，却有上千个线程，每个CPU只运行一个线程就糟了。
* 第二个策略就是如何在每个CPU上切换执行这一大堆线程，本节课我们关注的重点就是这个。假设我们只有一个CPU外加1000个线程，接下来我们会看到xv6是如何实现线程切换的，使得xv6先运行一个线程，保存状态之后再运行第二个线程，然后再是第三个线程，以此类推直到每个线程都运行了一会，再回来重新运行第一个线程。

![img](.assets/image%20(560).png)

实际上与大多数操作系统一样，xv6结合了两种策略，首先线程会运行在所有的CPU上，其次每个CPU会在多个线程之间切换执行，通常来说线程数量一般都多于CPU的数量。

不同线程系统之间的一个主要的区别就是，线程之间是否共享内存。一种可能的情况是，你有一个地址空间，多个线程都在这个地址空间里面运行，并且它们可以看到彼此的更新。比如说共享一个地址空间的线程修改了一个变量，共享地址空间的另一个线程可以看到变量的修改。所以当多个线程运行在一个共享地址空间时，我们需要用到上节课讲到的锁。

xv6内核支持共享内存，xv6支持内核线程的概念，对于每个用户进程都有一个内核线程来执行来自用户进程的系统调用，所有的内核线程共享内核内存（都使用内核地址空间），所以xv6的内核线程是共享内存的。

另一方面，xv6还有另外一种线程。每个用户进程都有独立的地址空间，并且包含了一个线程，这个线程控制了用户进程的代码指令的执行。所以xv6中的用户线程之间没有共享内存，你可以有多个用户进程，但是每个用户进程都是拥有一个线程的独立地址空间。xv6的进程不会共享内存。

在某些更复杂的操作系统中，比如Linux，允许在一个用户进程中包含多个线程，进程中的多个线程共享该进程的地址空间。当你想要实现一个运行在多个CPU上的用户进程时，你可以在Linux的进程中创建多个线程。Linux中也用到了许多我们今天会介绍的技术，但是在Linux中跟踪一个进程里面的多个线程比xv6中每个进程只有一个线程的复杂很多。

![img](.assets/image%20(491).png)

还有一些其他的方式可以支持在一台计算机上交织的运行多个任务，我们不会讨论它们，但是如果你感兴趣的话，你可以去搜索event-driven programming或者state machine，这些是在一台计算机上不使用线程但又能运行多个任务的技术。在所有的支持多任务的方法中，线程技术并不是非常有效的方法，但是线程通常是最方便，对程序员最友好的，并且可以用来支持大量不同任务的方法。