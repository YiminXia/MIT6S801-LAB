# 二层网络 --- Ethernet

[toc]

让我从最底层开始，我们先来看一下一个以太网packet的结构是什么。当两个主机非常靠近时，或许是通过相同的线缆连接，或许连接在同一个wifi网络，或许连接到同一个以太网交换机。当局域网中两个主机彼此之间要通信时，最底层的协议是以太网协议。你可以认为Host1通过以太网将Frame传给Host2。Frame是以太网中用来描述packet的单词，本质上就是这两个主机在以太网上传输一个个byte。以太网协议会在Frame中塞入足够的信息，让两个Host之间可以彼此识别对方并进行packet交互。

要完成上述功能，每个packet的header都含有3个fields。3个fields之后跟着的是Ethernet payload。3个fields分别是目的以太网地址，源以太网地址，以及packet的类型。

![img](.assets/image%20(871).png)

目的以太网地址，源以太网地址都是48bit的长度，这个地址可以唯一标识网卡。packet的类型字段，告诉接收端的主机该如何处理这个packet，接收端的Host会检查该type字段，然后调用更上一层的网络协议来处理该payload。

整个以太网的packet，就是48+48+16+任何长度payload。当然Frame还有一些东西，是对于软件来说不可见的（ps，操作系统内核属于软件，这里指对操作系统内核不可见）。在以太网packet的开头有用来被硬件识别的表示packet开始的数据（注，Preamble + SFD），在packet结尾有几个bit表明packet的结束（注，FCS）。这两个表示开头跟结尾的flag永远不会被操作系统内核看到，但这个Frame剩下的部分会被从网卡传输到操作系统内核。

![img](.assets/image%20(745).png)

如果你做这门课的最后一个lab，你会发现那个实验分支代码下有一个文件kernel/net.h，这个文件按包含了大量的不同层级网络协议的packet header的definition。第一张图中的结构体就是以太网header的定义，我们提供的代码使用这个结构体定义来解析以太网的packet，获取packet的目的以太网地址和packet的type（注，实际中只需要对收到的raw data指针强制类型转换成结构体指针就可以完成解析）。

>学生提问：硬件用来识别以太网packet的开头和结束的标志是不是类似于lab中的End of Packets？
>
>Robert教授：不是的，EOP是帮助driver与网卡之间通信的机制。这里的开头跟结尾标识的flag是某种更低层级的用来表示bit位的电讯号，或者光讯号，这些讯号在Ethernet光缆中传输。以结束的FCS为例，它的值通常是packet header和payload的校验和，可以用来判断packet是否合法。

以太网的48bit的地址，其目的是保证每一张制造出来的网卡都有一个唯一的ID。48bit的前24bit表示网卡制造商，每个网卡制造商都有自己唯一的编号，后24bit是由网卡制造商唯一指定的一个数字，网卡制造商通常都是直接递增分配后24bit的数字。假如你买了6张网卡，你去查看他们的地址，你会发现，这批网卡的前24bit都是一样的，表示是同一个公司制造的，后24bit则是6个连续递增的数字。

虽然Ethernet地址是唯一的，但是出了LAN（ps, Local area network局域网），Ethernet address对于定位Host主机是没有帮助的。如果网络通信的目的Host跟源Host在同一个LAN，那么目的host会监听发送给自己的Ethernet packet。但是如果网络通信发生在两个国家的主机之间，你需要使用一个不同的寻址方法，这就是IP地址的作用。

你可以使用tcpdump软件来查看Ethernet packet，这将是最后一个lab必备的一部分工作，下图是tcpdump的一个输出：

![img](.assets/image%20(814).png)

tcpdump输出了很多信息：

* packet到达的时间
* 第一行的剩下部分是，这个packet的类型是啥，packet的一些数据
* 剩下的三行则是，收到的packet用16进制表示的样子

如果按照前面以太网header的格式，可以发现packet中：

* 前48bit是一个广播地址，0xffff ffff ffff。广播地址是指该packet是发送给LAN中的所有主机的
* 之后的48bit则是发送这个packet的以太网地址，这实际上是运行在QEMU下的xv6生成的以太网地址，所以地址中的前24bit并不是网卡制造商的编号，而是QEMU编造的地址。
* 接下来的16bit表示这个Ethernet packet的type，这里type值是0x0806代表ARP协议
* 剩下的部分则是ARP packet的payload部分。

