# 二三层地址转换--ARP

[toc]

下一层以太网通信相关的协议是ARP协议。在以太网层面，每个host都拥有一个以太网地址。但是为了能在Internet上面铜线，host需要拥有一个32bit的Internet地址（注，IP address即IP地址）。为什么需要IP地址呢？因为IP地址有额外的含义。IP地址的高bit位包含了在整个互联网中，这个packet的目的地在哪。

所以IP地址的高bit位对应的是网络号（Network number），虽然实际情况更加复杂，但是你可以认为Internet中每个网络都有一个唯一的网络号。路由器就是盯着这些IP地址的高bit位，然后决定将这个packet转发给互联网上哪一个路由器。

而IP地址的低bit位对应的是host在Local Network中主机号，当一个packet经过Internet的转发之后，到达一个Local Ethernet，我们需要在这个Local Ethernet中，通过32bit的IP address来获取host对应的48bit的ethernet  address。这里需要的是一个动态地址解析协议，dynamic address resolution protocol即ARP协议。

当一个packet到达一个路由器并且需要转发给同一个Ethernet Network中的另一台host时，或者一个host将packet发送给同一个Ethernet Network中的另一个主机时，发送方首先会在Local Area Network中广播一个ARP Request packet，并请求说，无论谁拥有这个IP地址，请回复您的48bit的Ethernet地址。如果相应的主机存在并且开机了，它会向发送方发送一个ARP response packet。

下图是一个ARP packet的格式：

![img](.assets/image%20(714).png)

上图中struct ARP这个结构体，实际会出现在Ethernet Frame的payload中。所以你会看到这样的结构，首先是Ethernet header，包含了48bit的Ethernet dest Address，48bit的Ethernet src address，16bit的type字段；之后的Ethernet payload会是ARP packet，包含了上述的内容

接收端host收到Ethernet Frame之后，通过查看type字段，知道这是一个ARP packet。ARP的Ethernet protocol number是0x0806，之后host会将该packet发送给内核中的ARP协议处理代码进行处理。

有关ARP packet中包含了很多信息，但是基本上就是在说，我现在有一个Internet地址，我想知道它的Ethernet地址，如果你知道的话，请响应我。

同样的，我们也可以通过tcpdump来查看这些packet。在网络的lab中，XV6会在QEMU模拟的环境下发送IP packet。所以你们可以看到在xv6和其他主机之间有ARP交互。下图的第一个packet是我的host想知道xv6的Ethernet地址，第二个packet是xv6收到第一个packet之后，意识到自己是IP地址的拥有者，返回的Response。

![img](.assets/image%20(831).png)

tcpdump能够解析出ARP packet，并将数据打印在第一行。对应ARP packet的格式，在第一个packet中，10.0.2.2是Sender IP address。10.0.2.15是DIP。在第二个packet中，52:54:00:12:34:56对应SHA。

同时，我们也可以自己分析packet的原始数据。对于第一个packet：

* 前14个byte（6+6+2）是Ethernet header，包含了48bit的Ethernet dest Address，48bit的Ethernet src address，16bit的type字段。
* 然后从后往前看，倒数4个字节是TIP（target IP Address），也就是发送方想要找出对应以太网地址的IP地址。我们知道4个字节，对应一个IP地址，所以`0x0a00 020f`对应的IP地址是`10.0.2.15`。
* 再向前数6个字节，是THA(target  hardware address)，也就是Ethernet destination Address，现在还不知道所以全是0。
* 再向前数4个字节是SIP(sender ip address)，也就是发送方的IP地址，`0x0a000202`对应了IP地址`10.0.2.2`。
* 再向前数6个字节是SHA(sender hardware address)，也就是发送方的以太网地址。
* 剩下的8个字节表明了我们感兴趣的是以太网和IP地址格式。

第二个packet是第一个packet的响应。

>学生提问：ethernet header中已经包括了发送方的以太网地址，为什么ARP packet里面还要包含发送方的以太网地址？
>
>Robert教授：我并不清楚为什么ARP packet里面包含了这些数据，我认为如果你想的话是可以精简一下ARP packet。或许我们可以这么理解，ARP协议被设计成也可以用在其他非以太网的网络中，所以它被设计成独立且不以来其他信息，所以ARP packet中包含了以太网地址。现在我们是在以太网中发送ARP packet，以太网packet也包含了以太网地址，所以，如果在以太网上运行ARP，这些信息是冗余的。但是如果在其他的网络上运行ARP，你或许需要这些信息，因为其他网络的packet中并没有包含以太网地址。
>
>学生提问：tcpdump中原始数据的右侧是什么内容？
>
>Robert教授：这些是原始数据对应的ASCII码，`.`对应了一个字节没有对应的ASCII码，0x52对应了R，0x55对应了U。当我们发送的packet包含了ASCII字符时，这里的信息会更加有趣。

我希望你们在刚刚的讨论中注意到这一点，网络协议和网络协议header是嵌套的。我们刚看到的一个packet拥有Ethernet header和Ethernet payload。在Ethernet payload中，第一部分是ARP header。对于ARP协议来说没有payload。但是Ethernet payload中还可以是其他更复杂的结构。

比如Ethernet packet中包含一个IP packet，IP packet中又是一个UDP packet，所以IP header后面跟着的是UDP header。如果在UDP中包含另一个协议，那么UDP payload中又可能包含其他的packet，例如DNS packet。所以发送packet的主机会按照这样的方式构建packet：

* DNS相关软件会说，我想发送一个packet，构建在UDP协议之上；
* UDP软件会先准备一个UDP header，挂在DNS packet之前，并在IP协议之上构建packet
* P相关的软件会将IP heade挂在UDP packet之前；
* 最后Ethernet相关的软件会将Ethernet header挂在IP header之前。

所以整个packet是在发送过程中逐渐构建起来的。

![img](.assets/image%20(821).png)

类似的，当一个操作系统收到一个packet，它会先解析一个header并知道这是Ethernet，经过一些合法性检查之后，读取type field字段，然后Ethernet header会被剥离。在Ethernet header中包含了一个类型字段，它表明了该如何解析下一个header。同样的在IP header中包含了一个protocol字段，它也表明了该如何解析下一个header。

![img](.assets/image%20(825).png)

软件会解析每个header，做校验，剥离header，并得到下一个header。一直重复这个过程直到得到最后的数据。这就是嵌套的packet header。