# 三层网络 --- Internet

[toc]

Ethernet header足够在一个局域网中将packet发送到一个host。如果你想在局域网发送一个IP packet，那么你可以使用ARP获得以太网地址。但是IP协议更加的通用，IP协议能帮助你向互联网上任意位置发送packet。下图是一个IP packet的header，你们可以在lab配套的代码中的net.h文件找到

![img](.assets/image%20(846).png)

如果是IP packet的话，那么你会先看到一个Ethernet packet，显示Ethernet dest address，然后是Ethernet src Address，然后是type字段此时的值是`0x0800`表示IP protocol，之后是IP header，最后是IP payload。

![img](.assets/image%20(725).png)

在一个packet发送到世界另一端的网络的过程中，IP header是会被一致保留的，当Ethernet Frame离开本地以太网（Local Ethernet）之后，Ethernet header就会被剥离掉。或许packet在被路由的过程中，在每一跳（hop）会加上一个新的Ethernet header。但是IP header从source host到destination host的过程中会一直被保留。

所以IP header具有全球全局意义，而Ethernet header只在单独的LAN中有意义，所以IP header必须包含足够的信息，这样才能将packet传输给Internet上遥远的另一端。对于我们来说，有三个关键字段，

* uint32 ip_dst：目的字段，一个32bit的目的IP地址，其中高位bit是目的网络号，帮助packet在Internet中路由。

* uint32 ip_src：源IP地段，也是一个32bit的IP地址。

* uint8 ip_p：protocol字段，当一个IP packet被送达目的地，protocol字段告诉目的主机，当目的host把IP header剥离之后，接下来该怎么处理这个IP payload。

如果你们看到过MIT的IP地址，你们可以看到IP地址是18.x.x.x，虽然最近有些变化，但是在很长一段时间18是MIT的网络号。所以MIT的大部分主机的IP地址最高字节就是18。全世界的路由器在看到网络号18的时候，就知道应该将packet路由到离MIT更近的地方。

接下来我们看一下包含了IP packet的tcpdump输出。

![img](.assets/image%20(695).png)

因为这个IP packet是在以太网上传输，所以它包含了以太网header。呃……，实际上这个packet里面有点问题，我不太确定具体的原因是什么，但是Ethernet header中目的以太网地址不应该是全f，因为全f是广播地址，它会导致packet被发送到所有的主机上。一个真实网络中两个主机之间的packet，不可能出现这样的以太网地址。所以我提供的针对network lab的方案，在QEMU上运行有点问题。

不管怎么样，我们看到了Ethernet dst address，Ethernet src Address，type字段值`0x0800`，表示Ethernet payload是一个IP packet。

![img](.assets/image%20(805).png)

IP header的长度是20byte。下图红色<font color=red>[]中括号</font>部分就是IP header：

![img](.assets/image%20(853).png)

从后向前看：

* uint32 ip_dst：目的IP地址，0x0a000202，也就是10.0.2.2。
* uint32 ip_src：源IP地址，0x0a00020f，也就是10.0.2.15。
* uint16 ip_sum：16bit的校验和（checksum）0x3eae，IP相关的软件代码来检测这个值，如果不匹配就会丢弃这个IP packet。
* uint8 ip_p：protocol字段，值为0x11，对应的十进制17，表示IP payload是一个UDP packet。
* 其他的就是我们不太关心的一些字段了，例如packet的长度。

IP header中的protocol字段告诉接收端host主机的网络协议栈，这个IP packet需要被UDP相关的软件代码处理。









