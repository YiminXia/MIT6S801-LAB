# 网络协议栈

[toc]

与packet的协议和格式对应的是运行在主机上的网络协议栈。人们有各种各样的方式来组织网络软件，接下来我会介绍最典型的，并且至少我认为是最标准的组织方式。

假设我们现在运行在linux或者xv6，我们有一些应用程序比如web browser，DNS服务器。这些应用程序都使用socket API打开了socket layer层的文件描述符。socket layer层是内核中的一层软件，socket layer维护了一个表单来记录文件描述符fd与UDP/TCP端口号之间的关系。同时它也会为每个socket维护一个队列用来存储接收到的packet。我们在networking lab中提供的代码模板包含了一个非常原始的socket layer。

![img](.assets/image%20(703).png)

在socket layer之下是UDP与TCP协议层。

* UDP软件几乎不做任何事情，它只是检查收到的packet，获取目的端口号，并将UDP payload发送给socket layer的目的端口号对应的fd的incoming queue上。

* TCP软件会复杂的多，它会维护每个TCP连接的state信息。它记录了所有的packet的sequence number，哪些packet没有被ACK，哪些packet需要重传。所以TCP的protocol control block中记录了大量的状态信息，但是UDP中不会记录任何状态信息。

UDP与TCP通常被称为传输层。networking lab提供的代码中有一个简单的UDP层，但是没有TCP的代码。

![img](.assets/image%20(644).png)

在TCP/UDP之下是IP层，IP层的软件通常很简单。与IP层在一起的还有ARP层，虽然我不确定是在同一层还是下一层。

![img](.assets/image%20(666).png)

再向下的话，我们可以认为还有一个以太网层。但是通常来说并没有一个独立的以太网层，这个位置是一个或多个网卡驱动（nic drivers）,这些网卡驱动与实际的物理网卡（Network interface hardware）进行交互。网卡硬件与局域网会有实际的连接。

![img](.assets/image%20(705).png)

当一个packet从网络被送达时，网卡会从网络中将packet接收然后送往网卡驱动，网卡驱动会将packet送往网络协议栈。在IP层，软件会检查IP header，将其剥离之后，再把剩下的数据送往UDP。UDP层会校验UDP header，将其剥离之后，再把剩下的数据加入到socket layer层中相应fd对应的incoming queue中。在一个packet送达网卡之后，会一路解析并一路剥离每一层的header。当应用程序发送一个packet时，一路向下每一层增加一个header，直到最底层packet再被传递给硬件网卡用来在网络中传输。所以内核中的网络软件通常都是被嵌套的协议所驱动。

这里实际我忘了一个重要的事情，整个处理流程中都会有packet buffer。当收到一个packet之后，它会拷贝到一个packet buffer中，这个packet buffer会在网络协议栈中传输。通常在不同的协议层之间会有Queue队列，比如在socket layer层就有一个等待被应用程序处理的packet队列。这个队列其实就是一个packet buffer的linked list。通常整个网络协议栈都会使用buffer分配器，buffer结构。在我们提供的networking lab代码中，buffer接口名叫MBUF。

![img](.assets/image%20(646).png)

以上就是一个典型的网络协议栈的分层图。